<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>훈련정보API 임베드 위젯</title>
  <style>
    :root {
      --fg:#0b1324; --muted:#667085; --bd:#e5e7eb; --bg:#f8fafc; --primary:#2563eb;
      --card:#ffffff; --accent:#eef2ff; --accent-bd:#c7d2fe; --link:#1d4ed8;
    }
    @media (prefers-color-scheme: dark){
      :root{ --fg:#e5e7eb; --muted:#a3a3a3; --bd:#262b36; --bg:#0b1220; --primary:#60a5fa; --card:#0f172a; --accent:#0b1a38; --accent-bd:#1f3b7a; --link:#93c5fd; }
      body{ background:#0b1220; }
    }
    *{ box-sizing: border-box; }
    html, body { height:100%; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun 고딕", "맑은 고딕", sans-serif; color:var(--fg); background:#fff; }

    .wrap{ padding:6px 8px; }

    /* Card */
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:13px; box-shadow: 0 3px 10px rgba(15,23,42,0.06); }
    .card-header{ display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:1px solid var(--bd); }
    .title{ font-size:15px; font-weight:700; margin:0; letter-spacing:-0.01em; }
    .meta{ color:var(--muted); font-size:11px; }
    .card-body{ padding:6px 8px; }

    /* Table (Compact) */
    .table-wrap{ overflow:auto; border-radius:10px; border:1px solid var(--bd); }
    table{ width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
    thead th{ position:sticky; top:0; z-index:1; background:linear-gradient(#fff,#fff); font-weight:600; color:var(--fg); }
    thead th, tbody td{ padding:6px 8px; border-bottom:1px solid var(--bd); font-size:12px; line-height:1.3; text-align:left; vertical-align:middle; }
    tbody tr:nth-child(odd){ background:#fafafa; }
    @media (prefers-color-scheme: dark){ tbody tr:nth-child(odd){ background:#0d1526; } thead th{ background:linear-gradient(#0f172a,#0f172a); } }
    tbody tr:hover{ background: var(--accent); }
    @media (prefers-color-scheme: dark){ tbody tr:hover{ background:#0b1a38; } }

    /* Column widths */
    colgroup col:nth-child(1){ width:12%; }   /* 주소 */
    colgroup col:nth-child(2){ width:14%; }  /* 훈련기관 */
    colgroup col:nth-child(3){ width:40%; }  /* 훈련과정 */
    colgroup col:nth-child(4){ width:12%; }  /* 시작일자 */
    colgroup col:nth-child(5){ width:12%; }  /* 종료일자 */
    colgroup col:nth-child(6){ width:10%; }  /* 세부정보 */

    /* Cells */
    .wrap{ white-space:normal; overflow-wrap:anywhere; word-break:keep-all; }
    .org{ white-space:normal; word-break:keep-all; line-height:1.35; }
    .badge{ display:inline-block; padding:2px 6px; font-size:11px; border:1px solid var(--accent-bd); background:var(--accent); border-radius:999px; }
    .link-btn{ display:inline-flex; align-items:center; justify-content:center; padding:4px 8px; font-size:11px; font-weight:600; color:#fff; background:var(--primary); border-radius:999px; text-decoration:none; min-width:48px; }
    .link-btn:focus{ outline:2px solid var(--accent-bd); outline-offset:2px; }

    /* Remove extra gaps below table */
    .footer, #hint{ display:none; height:0; margin:0; padding:0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="cardRoot">
      <div class="card-header">
        <h2 class="title">현재 모집 중인 훈련과정</h2>
        <div class="meta" id="meta">불러오는 중…</div>
      </div>
      <div class="card-body">
        <div class="table-wrap" id="tableWrap"></div>
        <div class="footer" id="footerNote"></div>
        <div class="meta" id="hint"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const meta = $('#meta');
  const tableWrap = $('#tableWrap');
  const cardRoot = $('#cardRoot');

  // ── 고용24 XML API (사용 중인 URL 넣으세요) ──
  const DEFAULT_API =
    'https://www.work24.go.kr/cm/openApi/call/hr/callOpenApiSvcInfo310L01.do?authKey=YOUR_KEY&returnType=XML&outType=1&pageNum=1&pageSize=100&srchTraArea1=50&crseTracseSe=C0102&sort=ASC&sortCol=TRNG_BGDE';
  const qs = new URLSearchParams(location.search);
  const apiUrl = decodeURIComponent(qs.get('api')||'').trim() || DEFAULT_API;

  // ── 표 컬럼(필드 키 고정) ──
  const COLUMNS = [
    { key:'address',      label:'주소' },
    { key:'subTitle',     label:'훈련기관' },
    { key:'title',        label:'훈련과정' },
    { key:'traStartDate', label:'시작일자' },
    { key:'traEndDate',   label:'종료일자' },
    { key:'titleLink',    label:'세부정보' }
  ];

  // ── 유틸 ──
  function clean(t){
    t = t.replace(/^\uFEFF/, '');
    t = t.replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F]/g, '');
    t = t.replace(/\u00A0/g, ' ');
    return t.trim();
  }
  function decodeUtf8(buf){
    try { return new TextDecoder('utf-8', { fatal:false }).decode(buf); }
    catch { return new TextDecoder().decode(buf); }
  }

  // ── 1) 정상 XML 파싱: 실제 태그명에 정확 매핑 ──
  function parseXmlExact(xmlText){
    const parser = new DOMParser();
    const xml = parser.parseFromString(xmlText, 'application/xml');
    if (xml.querySelector('parsererror')) return null;

    // 목록 노드 자동 탐색(반복/자식 수 기반)
    const all = [...xml.getElementsByTagName('*')];
    let best=null, bestScore=-1;
    const count = new Map();
    all.forEach(n => count.set(n.tagName, (count.get(n.tagName)||0)+1));
    count.forEach((cnt, name)=>{
      const nodes = xml.getElementsByTagName(name);
      if (!nodes.length) return;
      const sample = [...nodes].slice(0, Math.min(nodes.length, 10));
      const avgKids = sample.reduce((s,n)=>s+n.children.length,0)/sample.length;
      const score = cnt + avgKids*50;
      if (avgKids>=3 && cnt>=5 && name!==xml.documentElement.tagName && score>bestScore){ best=name; bestScore=score; }
    });
    const items = best? [...xml.getElementsByTagName(best)] : [];
    if (!items.length) return null;

    // 실제 태그명 → 표 컬럼 매핑
    // (제공해주신 예시)
    return items.map(node=>{
      const pick = tag => {
        const el = node.getElementsByTagName(tag)[0];
        return el ? (el.textContent||'').trim() : '';
      };
      const address      = pick('address');
      const subTitle     = pick('subTitle');
      const title        = pick('title');
      const traStartDate = pick('traStartDate'); // 예: 2025-11-14
      const traEndDate   = pick('traEndDate');   // 예: 2025-11-25
      const titleLink    = pick('titleLink') || pick('subTitleLink'); // 둘 중 하나라도
      return { address, subTitle, title, traStartDate, traEndDate, titleLink };
    });
  }

  // ── 2) 평문 스트림 폴백 파서(모바일에 태그가 날아간 경우) ──
  // 패턴 단서:
  //  - PCOCO/PCOBO 링크
  //  - 날짜 YYYY-MM-DD 2개
  //  - 전화번호 0xx-xxx-xxxx
  //  - "제주 제주시|서귀포시" 주소 패턴
  function parsePlainStream(text){
    const t = text.replace(/\s+/g, ' ').trim();

    // 항목 시작을 PCOCO 링크로 구분
    const cocoRe = /https?:\/\/hrd\.work24\.go\.kr\/hrdp\/co\/pcoco\/PCOCO0100P\.do\?[^ \t]+/gi;
    const cocoMatches = [...t.matchAll(cocoRe)];
    if (!cocoMatches.length) return [];

    const items = [];
    for (let i=0;i<cocoMatches.length;i++){
      const m = cocoMatches[i];
      const start = Math.max(0, m.index - 220); // 링크 앞쪽 일부 포함
      const end   = (i+1 < cocoMatches.length ? cocoMatches[i+1].index : t.length);
      const chunk = t.slice(start, end);

      const cocoLink = m[0];
      const coboMatch = chunk.match(/https?:\/\/hrd\.work24\.go\.kr\/hrdp\/co\/pcobo\/PCOBO0100P\.do\?[^ \t]+/i);
      const coboLink = coboMatch ? coboMatch[0] : '';

      // 날짜 2개(시작/종료)
      const dates = [...chunk.matchAll(/20\d{2}-\d{2}-\d{2}/g)].map(x=>x[0]);
      const traStartDate = dates.length>=2 ? dates[dates.length-2] : (dates[0]||'');
      const traEndDate   = dates.length   ? dates[dates.length-1] : '';

      // 전화
      const tel = (chunk.match(/\(?0\d{1,2}-\d{3,4}-\d{4}\)?/g)||[]).pop() || '';

      // 주소(간단 패턴)
      const addrMatch = chunk.match(/제주\s+(제주시|서귀포시)/);
      const address = addrMatch ? `제주 ${addrMatch[1]}` : '';

      // 기관: cocoLink 바로 앞 한글/영문/숫자 덩어리
      let subTitle = '';
      {
        const before = chunk.slice(0, chunk.indexOf(cocoLink));
        const orgCand = (before.match(/[\p{sc=Hangul}A-Za-z0-9\(\)·\-\s]{3,}$/u)||[])[0] || '';
        subTitle = orgCand.replace(/\s{2,}/g,' ').trim();
      }

      // 제목: 전화 이후 ~ coboLink 이전의 한글 덩어리 (전화 없으면 cocoLink 이후 ~ coboLink 이전)
      let title = '';
      {
        let fromIdx = tel ? chunk.indexOf(tel) + tel.length : chunk.indexOf(cocoLink) + cocoLink.length;
        let toIdx = coboLink ? chunk.indexOf(coboLink) : chunk.length;
        if (fromIdx<0) fromIdx = 0;
        if (toIdx<fromIdx) toIdx = chunk.length;
        const mid = chunk.slice(fromIdx, toIdx);
        const titleCand = (mid.match(/[\p{sc=Hangul}0-9A-Za-z\(\)\[\]·\-\s]{6,}?/u)||[])[0] || '';
        title = titleCand.replace(/\s{2,}/g,' ').trim();
      }

      items.push({
        address,
        subTitle,
        title,
        traStartDate,
        traEndDate,
        titleLink: coboLink || cocoLink // 모집/상세 중 하나라도
      });
    }
    return items;
  }

  // ── 테이블 렌더 ──
  function render(rows){
    const thead = '<thead><tr>' + COLUMNS.map(c=>`<th>${c.label}</th>`).join('') + '</tr></thead>';
    const tbody = '<tbody>' + (rows.length? rows.map(r=>{
      const linkTd = r.titleLink ? `<a class="link-btn" href="${r.titleLink}" target="_blank" rel="noopener">자세히</a>` : '';
      return `<tr>
        <td>${r.address||''}</td>
        <td>${r.subTitle||''}</td>
        <td>${r.title||''}</td>
        <td>${r.traStartDate||''}</td>
        <td>${r.traEndDate||''}</td>
        <td>${linkTd}</td>
      </tr>`;
    }).join('') : '<tr><td colspan="6">표시할 데이터가 없습니다.</td></tr>') + '</tbody>';
    tableWrap.innerHTML = `<table><colgroup><col><col><col><col><col><col></colgroup>${thead}${tbody}</table>`;
    queueHeight();
  }

  // ── 높이 연동(기존) ──
  let rafId=null;
  function h(){ return Math.ceil(cardRoot.getBoundingClientRect().height + 1); }
  function postH(){ try{ parent.postMessage({ type:'rsc-widget-height', height:h() }, '*'); }catch(e){} }
  function queueHeight(){ if (rafId) cancelAnimationFrame(rafId); rafId = requestAnimationFrame(postH); }
  const ro = new ResizeObserver(queueHeight);
  ro.observe(cardRoot); ro.observe(tableWrap);
  if (document.fonts && document.fonts.ready) { document.fonts.ready.then(queueHeight).catch(()=>{}); }
  window.addEventListener('resize', queueHeight);
  window.addEventListener('load', queueHeight);

  // ── 가져오기(3단계 폴백) ──
  async function fetchRobust(url){
    // 1) fetch(arrayBuffer)
    try{
      const r = await fetch(url, {
        method:'GET', cache:'no-store', credentials:'omit',
        referrerPolicy:'no-referrer', mode:'cors', redirect:'follow',
        headers:{ 'Accept':'application/xml, text/xml;q=0.9, */*;q=0.8' }
      });
      if (!r.ok) throw new Error('HTTP '+r.status);
      const buf = await r.arrayBuffer();
      return clean(decodeUtf8(buf));
    }catch(_){
      // 2) fetch(text)
      try{
        const r2 = await fetch(url, {
          method:'GET', cache:'no-store', credentials:'omit',
          referrerPolicy:'no-referrer', mode:'cors', redirect:'follow',
          headers:{ 'Accept':'application/xml, text/xml;q=0.9, */*;q=0.8' }
        });
        if (!r2.ok) throw new Error('HTTP '+r2.status);
        return clean(await r2.text());
      }catch(__){
        // 3) XHR(document)
        return await new Promise((resolve, reject)=>{
          const xhr = new XMLHttpRequest();
          xhr.open('GET', url, true);
          try{ xhr.responseType='document'; }catch(_){}
          try{ xhr.overrideMimeType('text/xml'); }catch(_){}
          xhr.setRequestHeader('Accept','application/xml, text/xml;q=0.9, */*;q=0.8');
          xhr.onload=()=>{
            if (xhr.status>=200 && xhr.status<300){
              if (xhr.responseXML){
                resolve(new XMLSerializer().serializeToString(xhr.responseXML));
              }else if (xhr.responseText){
                resolve(clean(xhr.responseText));
              }else reject(new Error('빈 응답'));
            }else reject(new Error('HTTP '+xhr.status));
          };
          xhr.onerror=()=>reject(new Error('XHR 네트워크 오류'));
          xhr.send();
        });
      }
    }
  }

  // ── 메인 ──
  async function fetchData(){
    meta.textContent='불러오는 중…';
    try{
      const PROXY = 'https://jejuhrd.ehdvosxl.workers.dev/';
      const raw = await fetchRobust(PROXY + encodeURIComponent(apiUrl));

      // 우선 XML 파싱 시도(정확 매핑)
      let rows = null;
      if (raw.includes('<')) {
        rows = parseXmlExact(raw);
      }
      // XML이 아니거나 실패하면 평문 파서
      if (!rows || !rows.length){
        rows = parsePlainStream(raw);
      }

      render(rows || []);
      meta.textContent = `최종 갱신: ${new Date().toLocaleString()} · ${(rows||[]).length.toLocaleString()}건`;
    }catch(err){
      console.error(err);
      tableWrap.innerHTML = `
        <div style="padding:8px; color:#b91c1c;">
          데이터를 불러오지 못했습니다. ${err?.message || '네트워크/파싱 오류'}
          <div style="margin-top:6px; color:#6b7280; font-size:12px;">
            모바일에서 XML이 평문으로 변형되는 경우를 대비해 폴백 파서를 적용했습니다. 포맷이 바뀌면 규칙 보강이 필요할 수 있습니다.
          </div>
        </div>`;
      meta.textContent = '오류 발생';
      queueHeight();
    }
  }

  fetchData();
})();
</script>
</body>
</html>
