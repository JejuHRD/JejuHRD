<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í›ˆë ¨ì •ë³´API ì„ë² ë“œ ìœ„ì ¯</title>
  <style>
    :root {
      --fg:#0b1324; --muted:#667085; --bd:#e5e7eb; --bg:#f8fafc; --primary:#2563eb;
      --card:#ffffff; --accent:#eef2ff; --accent-bd:#c7d2fe; --link:#1d4ed8;
    }
    @media (prefers-color-scheme: dark){
      :root{ --fg:#e5e7eb; --muted:#a3a3a3; --bd:#262b36; --bg:#0b1220; --primary:#60a5fa; --card:#0f172a; --accent:#0b1a38; --accent-bd:#1f3b7a; --link:#93c5fd; }
      body{ background:#0b1220; }
    }
    *{ box-sizing: border-box; }
    html, body { height:100%; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun ê³ ë”•", "ë§‘ì€ ê³ ë”•", sans-serif; color:var(--fg); background:#fff; }

    .wrap{ padding:6px 8px; }

    /* Card */
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:13px; box-shadow: 0 3px 10px rgba(15,23,42,0.06); }
    .card-header{ display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:1px solid var(--bd); }
    .title{ font-size:15px; font-weight:700; margin:0; letter-spacing:-0.01em; }
    .meta{ color:var(--muted); font-size:11px; }
    .card-body{ padding:6px 8px; }

    /* Table (Compact) */
    .table-wrap{ overflow:auto; border-radius:10px; border:1px solid var(--bd); }
    table{ width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
    thead th{ position:sticky; top:0; z-index:1; background:linear-gradient(#fff,#fff); font-weight:600; color:var(--fg); }
    thead th, tbody td{ padding:6px 8px; border-bottom:1px solid var(--bd); font-size:12px; line-height:1.3; text-align:left; vertical-align:middle; }
    tbody tr:nth-child(odd){ background:#fafafa; }
    @media (prefers-color-scheme: dark){ tbody tr:nth-child(odd){ background:#0d1526; } thead th{ background:linear-gradient(#0f172a,#0f172a); } }
    tbody tr:hover{ background: var(--accent); }
    @media (prefers-color-scheme: dark){ tbody tr:hover{ background:#0b1a38; } }

    /* Column widths */
    colgroup col:nth-child(1){ width:12%; }   /* ì£¼ì†Œ */
    colgroup col:nth-child(2){ width:14%; }  /* í›ˆë ¨ê¸°ê´€ */
    colgroup col:nth-child(3){ width:40%; }  /* í›ˆë ¨ê³¼ì • */
    colgroup col:nth-child(4){ width:12%; }  /* ì‹œì‘ì¼ì */
    colgroup col:nth-child(5){ width:12%; }  /* ì¢…ë£Œì¼ì */
    colgroup col:nth-child(6){ width:10%; }  /* ì„¸ë¶€ì •ë³´ */

    /* Cells */
    .wrap{ white-space:normal; overflow-wrap:anywhere; word-break:keep-all; }
    .org{ white-space:normal; word-break:keep-all; line-height:1.35; }
    .badge{ display:inline-block; padding:2px 6px; font-size:11px; border:1px solid var(--accent-bd); background:var(--accent); border-radius:999px; }
    .link-btn{ display:inline-flex; align-items:center; justify-content:center; padding:4px 8px; font-size:11px; font-weight:600; color:#fff; background:var(--primary); border-radius:999px; text-decoration:none; min-width:48px; }
    .link-btn:focus{ outline:2px solid var(--accent-bd); outline-offset:2px; }

    /* Remove extra gaps below table */
    .footer, #hint{ display:none; height:0; margin:0; padding:0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="cardRoot">
      <div class="card-header">
        <h2 class="title">í˜„ì¬ ëª¨ì§‘ ì¤‘ì¸ í›ˆë ¨ê³¼ì •</h2>
        <div class="meta" id="meta">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      </div>
      <div class="card-body">
        <div class="table-wrap" id="tableWrap"></div>
        <div class="footer" id="footerNote"></div>
        <div class="meta" id="hint"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const meta = $('#meta');
  const tableWrap = $('#tableWrap');
  const cardRoot = $('#cardRoot');

  // ===== Cloudflare Workers í”„ë¡ì‹œ ì„¤ì • =====
  const WORKERS_PROXY = 'https://jejuhrd.ehdvosxl.workers.dev/?url='; // âš ï¸ ì—¬ê¸°ì— ì‹¤ì œ Workers URL ì…ë ¥
  // ===== URL êµ¬ì„± (C: í”„ë¡ì‹œ í† ê¸€ ì§€ì›) =====
  const DEFAULT_API = 'https://www.work24.go.kr/cm/openApi/call/hr/callOpenApiSvcInfo310L01.do?authKey=24e8735a-f4b5-4537-9527-73759314444a&returnType=XML&outType=1&pageNum=1&pageSize=100&srchTraArea1=50&crseTracseSe=C0102&sort=ASC&sortCol=TRNG_BGDE';
  
  const qs = new URLSearchParams(location.search);
  const customApi = decodeURIComponent(qs.get('api')||'').trim();
  const apiUrl = customApi || DEFAULT_API;
  const finalUrl = WORKERS_PROXY + encodeURIComponent(apiUrl);

  console.log('ğŸ” ìµœì¢… ìš”ì²­ URL:', finalUrl);
  const apiUrl = decodeURIComponent(qs.get('api')||'').trim() || DEFAULT_API;
  const proxyBase = qs.get('proxy'); // ì˜ˆ: https://your-domain.kr/proxy/work24?url=
  const finalUrl = proxyBase ? (proxyBase + encodeURIComponent(apiUrl)) : apiUrl;

  const COLUMNS = [
    { key:'address',      label:'ì£¼ì†Œ',       cls:'text-ellipsis' },
    { key:'subTitle',     label:'í›ˆë ¨ê¸°ê´€',   cls:'org' },
    { key:'title',        label:'í›ˆë ¨ê³¼ì •',   cls:'text-ellipsis' },
    { key:'traStartDate', label:'ì‹œì‘ì¼ì' },
    { key:'traEndDate',   label:'ì¢…ë£Œì¼ì' },
    { key:'titleLink',    label:'ì„¸ë¶€ì •ë³´' }
  ];

  function normalizeFromXML(xmlText){
    console.log('ğŸ“„ XML íŒŒì‹± ì‹œì‘, ê¸¸ì´:', xmlText.length);
    console.log('ğŸ“„ XML ì•ë¶€ë¶„:', xmlText.substring(0, 500));
    
    const parser = new DOMParser();
    const xml = parser.parseFromString(xmlText, 'application/xml');
    
    if (xml.querySelector('parsererror')) {
      console.error('âŒ XML íŒŒì‹± ì—ëŸ¬');
      throw new Error('XML íŒŒì‹± ì˜¤ë¥˜');
    }
    
    if (xml.querySelector('parsererror')) throw new Error('XML íŒŒì‹± ì˜¤ë¥˜');
    const all = [...xml.getElementsByTagName('*')];
    console.log('ğŸ“Š ì „ì²´ íƒœê·¸ ìˆ˜:', all.length);
    
    let best = null, bestScore = -1;
    const count = new Map();
    all.forEach(n => count.set(n.tagName, (count.get(n.tagName)||0)+1));
    
    console.log('ğŸ·ï¸ íƒœê·¸ ê°œìˆ˜:', Object.fromEntries(count));
    
    count.forEach((cnt, name)=>{
      const nodes = xml.getElementsByTagName(name);
      if (!nodes.length) return;
      const sample = [...nodes].slice(0, Math.min(nodes.length, 10));
      const avgKids = sample.reduce((s,n)=>s+n.children.length,0)/sample.length;
      const score = cnt + avgKids*50;
      if (avgKids>=3 && cnt>=5 && name!==xml.documentElement.tagName && score>bestScore){ 
        best=name; 
        bestScore=score; 
        console.log(`âœ… í›„ë³´ íƒœê·¸: ${name}, ê°œìˆ˜: ${cnt}, í‰ê·  ìì‹: ${avgKids}`);
      }
      if (avgKids>=3 && cnt>=5 && name!==xml.documentElement.tagName && score>bestScore){ best=name; bestScore=score; }
    });
    
    console.log('ğŸ¯ ì„ íƒëœ íƒœê·¸:', best);
    
    const items = best? [...xml.getElementsByTagName(best)] : [];
    console.log('ğŸ“¦ ì•„ì´í…œ ìˆ˜:', items.length);
    
    if (items.length > 0) {
      console.log('ğŸ“ ì²« ë²ˆì§¸ ì•„ì´í…œ ìƒ˜í”Œ:', items[0].textContent.substring(0, 200));
    }
    
    return items.map(node=>{
      const obj = {};
      [...node.children].forEach(ch=>{ 
        obj[ch.tagName] = ch.children.length? ch.textContent.trim() : (ch.textContent||'').trim(); 
      });
      [...node.children].forEach(ch=>{ obj[ch.tagName] = ch.children.length? ch.textContent.trim() : (ch.textContent||'').trim(); });
      return obj;
    });
  }

  function normalizeFromJSON(json){
    let arr = Array.isArray(json) ? json : null;
    if (!arr){
      const stack=[json];
      while(stack.length && !arr){
        const cur = stack.pop();
        for (const [k,v] of Object.entries(cur||{})){
          if (Array.isArray(v) && v.length){ arr = v; break; }
          else if (v && typeof v==='object') stack.push(v);
        }
      }
    }
    if (!arr) throw new Error('JSONì—ì„œ ëª©ë¡ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
    return arr;
  }

  function render(rows){
    console.log('ğŸ¨ ë Œë”ë§ ì‹œì‘, í–‰ ìˆ˜:', rows.length);
    
    const thead = '<thead><tr>' + COLUMNS.map(c=>`<th>${c.label}</th>`).join('') + '</tr></thead>';
    const tbody = '<tbody>' + (rows.length? rows.map(r=>{
      const tds = COLUMNS.map(c=>{
        if (c.key==='titleLink' && r[c.key]){
          const url = String(r[c.key]).trim();
          return `<td><a class="link-btn" href="${url}" target="_blank" rel="noopener" aria-label="ì„¸ë¶€ì •ë³´ ìì„¸íˆ ì´ë™">ìì„¸íˆ</a></td>`;
          return `<td><a class=\"link-btn\" href=\"${url}\" target=\"_blank\" rel=\"noopener\" aria-label=\"ì„¸ë¶€ì •ë³´ ìì„¸íˆ ì´ë™\">ìì„¸íˆ</a></td>`;
        }
        const v = r[c.key] ?? '';
        const cls = c.cls? ` class="${c.cls}"` : '';
        const cls = c.cls? ` class=\"${c.cls}\"` : '';
        return `<td${cls}>${v}</td>`;
      }).join('');
      return `<tr>${tds}</tr>`;
    }).join('') : '<tr><td colspan="6">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>') + '</tbody>';

    tableWrap.innerHTML = `<table><colgroup>
      <col><col><col><col><col><col>
    </colgroup>${thead}${tbody}</table>`;

    queueHeight();
  }

  // ====== ìë™ ë†’ì´ ì¡°ì • ======
  let rafId = null;
  function computeHeight(){
    const rect = cardRoot.getBoundingClientRect();
    return Math.ceil(rect.height + 1);
  }
  function postHeight(){
    try { parent.postMessage({ type:'rsc-widget-height', height: computeHeight() }, '*'); } catch (e) {}
  }
  function queueHeight(){
    if (rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(postHeight);
  }

  const ro = new ResizeObserver(queueHeight);
  ro.observe(cardRoot);
  ro.observe(tableWrap);

  if (document.fonts && document.fonts.ready) {
    document.fonts.ready.then(queueHeight).catch(()=>{});
  }

  async function fetchData(){
    meta.textContent='ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
    console.log('ğŸš€ ë°ì´í„° ìš”ì²­ ì‹œì‘');
    
    try{
      console.log('ğŸ“¡ fetch í˜¸ì¶œ:', finalUrl);
      
      // (A) fetch ì˜µì…˜ ë³´ê°•
      const res = await fetch(finalUrl, {
        method: 'GET',
        cache: 'no-store',
        referrerPolicy: 'no-referrer',
        credentials: 'omit',
      });
      
      console.log('ğŸ“¥ ì‘ë‹µ ìƒíƒœ:', res.status, res.statusText);
      console.log('ğŸ“¥ ì‘ë‹µ í—¤ë”:', [...res.headers.entries()]);
      
      if (!res.ok) throw new Error('HTTP '+res.status);

      const text = await res.text();
      console.log('ğŸ“„ ì‘ë‹µ í…ìŠ¤íŠ¸ ê¸¸ì´:', text.length);
      console.log('ğŸ“„ ì‘ë‹µ ì•ë¶€ë¶„:', text.substring(0, 300));

      let rows = [];
      // (B) ìœ ì—° íŒŒì‹±: JSON â†’ XML â†’ (ì‹¤íŒ¨ ì‹œ) ì•ˆë‚´
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      console.log('ğŸ“‹ Content-Type:', ct);
      
      // XML íŒŒì‹± ì‹œë„
      rows = normalizeFromXML(text);
      console.log('âœ… íŒŒì‹±ëœ í–‰ ìˆ˜:', rows.length);

      if (rows.length > 0) {
        console.log('ğŸ“¦ ì²« ë²ˆì§¸ ë°ì´í„°:', rows[0]);
      let rows = [];
      if (ct.includes('json')){
        const json = await res.json();
        rows = normalizeFromJSON(json);
      } else {
        const text = await res.text();
        try {
          rows = normalizeFromXML(text);
        } catch (e) {
          throw new Error('ì •ìƒ XML/JSON ì‘ë‹µì´ ì•„ë‹™ë‹ˆë‹¤. (ëª¨ë°”ì¼ ë³´ì•ˆ/ì°¨ë‹¨ í˜ì´ì§€ ê°€ëŠ¥)');
        }
      }

      const pruned = rows.map(o=>{
        const r={};
        COLUMNS.forEach(c=> r[c.key] = o[c.key] ?? '');
        return r;
      });
      
      console.log('âœ‚ï¸ ì •ë¦¬ëœ ë°ì´í„° ìƒ˜í”Œ:', pruned[0]);
      
      render(pruned);
      meta.textContent = `ìµœì¢… ê°±ì‹ : ${new Date().toLocaleString()} Â· ${pruned.length.toLocaleString()}ê±´`;
      console.log('âœ… ë Œë”ë§ ì™„ë£Œ');
      
    }catch(err){
      console.error('âŒ ì „ì²´ ì—ëŸ¬:', err);
      console.error('âŒ ì—ëŸ¬ ìŠ¤íƒ:', err.stack);
      
      let errorMsg = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ';
      if (err.name === 'TypeError' && err.message.includes('Failed to fetch')) {
        errorMsg += 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜. Workers URLì„ í™•ì¸í•˜ì„¸ìš”.';
      } else {
        errorMsg += (err && err.message ? err.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
      }
      
      tableWrap.innerHTML = `<div style="padding:12px; color:#b91c1c; line-height:1.6;">
        <strong>âš ï¸ ${errorMsg}</strong><br>
        <small style="color:#6b7280;">ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.</small>
      </div>`;
      console.error(err);
      tableWrap.innerHTML = '<div style="padding:8px; color:#b91c1c;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. '+ (err && err.message ? err.message : '') + '</div>';
      meta.textContent = 'ì˜¤ë¥˜ ë°œìƒ';
      queueHeight();
    }
  }

  window.addEventListener('resize', queueHeight);
  window.addEventListener('load', queueHeight);
  fetchData();
})();
</script>
</body>
</html>
